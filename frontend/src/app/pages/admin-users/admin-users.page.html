<section class="admin-users" aria-labelledby="users-admin-title">
  <header class="admin-users__header">
    <div>
      <h2 id="users-admin-title">Gest√£o de usu√°rios</h2>
      <p>Visualize os perfis cadastrados e acompanhe quem possui acessos administrativos √† Pok√©dx.</p>
    </div>
    <div class="admin-users__actions">
      <button type="button" class="btn-secondary" (click)="loadUsers()" [disabled]="loading()">
        {{ loading() ? 'Atualizando...' : 'Atualizar lista' }}
      </button>
      <button type="button" class="btn-primary" (click)="toggleCreateForm()">
        {{ showCreateForm() ? 'Cancelar' : 'Criar usu√°rio' }}
      </button>
    </div>
  </header>

  <!-- Formul√°rio de cria√ß√£o de usu√°rio -->
  <form *ngIf="showCreateForm()" [formGroup]="createForm" (ngSubmit)="submitCreate()" class="admin-users__form" novalidate>
    <h3>Criar novo usu√°rio</h3>

    <div class="form-row">
      <div class="form-group">
        <label for="create_username">Nome de usu√°rio</label>
        <input
          id="create_username"
          type="text"
          formControlName="username"
          [class.invalid]="createForm.controls.username.invalid && createForm.controls.username.touched"
          required
        />
        <small *ngIf="createForm.controls.username.invalid && createForm.controls.username.touched">
          Nome de usu√°rio deve ter pelo menos 3 caracteres.
        </small>
      </div>

      <div class="form-group">
        <label for="create_email">E-mail (opcional)</label>
        <input
          id="create_email"
          type="email"
          formControlName="email"
          [class.invalid]="createForm.controls.email.invalid && createForm.controls.email.touched"
        />
        <small *ngIf="createForm.controls.email.invalid && createForm.controls.email.touched">
          Informe um e-mail v√°lido.
        </small>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="create_password">Senha</label>
        <input
          id="create_password"
          type="password"
          formControlName="password"
          [class.invalid]="createForm.controls.password.invalid && createForm.controls.password.touched"
          required
        />
        <small *ngIf="createForm.controls.password.invalid && createForm.controls.password.touched">
          Senha deve ter pelo menos 8 caracteres.
        </small>
      </div>

      <div class="form-group">
        <label for="create_password_confirm">Confirmar senha</label>
        <input
          id="create_password_confirm"
          type="password"
          formControlName="password_confirm"
          [class.invalid]="createForm.controls.password_confirm.invalid && createForm.controls.password_confirm.touched"
          required
        />
        <small *ngIf="createForm.controls.password_confirm.invalid && createForm.controls.password_confirm.touched">
          Confirme a senha.
        </small>
      </div>
    </div>

    <div class="form-group">
      <label class="checkbox-label">
        <input
          type="checkbox"
          formControlName="is_staff"
        />
        <span class="checkbox-custom"></span>
        Conceder privil√©gios de administrador
      </label>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="toggleCreateForm()">Cancelar</button>
      <button type="submit" class="btn-primary" [disabled]="actionLoading()">
        {{ actionLoading() ? 'Criando...' : 'Criar usu√°rio' }}
      </button>
    </div>
  </form>

  <ng-container *ngIf="!loading(); else loadingState">
    <div *ngIf="users().length > 0; else emptyState" class="admin-users__table" role="table" aria-label="Tabela de usu√°rios cadastrados">
      <div class="admin-users__row admin-users__row--header" role="row">
        <span role="columnheader">Usu√°rio</span>
        <span role="columnheader">E-mail</span>
        <span role="columnheader">Administrador</span>
        <span role="columnheader">Criado em</span>
        <span role="columnheader">A√ß√µes</span>
      </div>

      <!-- Linha de edi√ß√£o inline -->
      <div *ngIf="editingUser() as user" class="admin-users__row admin-users__row--edit" role="row">
        <form [formGroup]="editForm" (ngSubmit)="submitEdit()" class="edit-form">
          <span role="cell">
            <input
              type="text"
              formControlName="username"
              placeholder="Nome de usu√°rio"
              [class.invalid]="editForm.controls.username.invalid && editForm.controls.username.touched"
            />
          </span>
          <span role="cell">
            <input
              type="email"
              formControlName="email"
              placeholder="E-mail"
              [class.invalid]="editForm.controls.email.invalid && editForm.controls.email.touched"
            />
          </span>
          <span role="cell">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="is_staff" />
              <span class="checkbox-custom"></span>
              Admin
            </label>
          </span>
          <span role="cell">{{ user.date_joined | date: 'dd/MM/yyyy HH:mm' }}</span>
          <span role="cell" class="table-actions">
            <button type="submit" class="btn-icon btn-success" [disabled]="actionLoading()" title="Salvar">
              ‚úì
            </button>
            <button type="button" class="btn-icon btn-secondary" (click)="cancelEdit()" title="Cancelar">
              ‚úï
            </button>
          </span>
        </form>
      </div>

      <div *ngFor="let user of users()" class="admin-users__row" role="row" [class.editing]="editingUser()?.id === user.id">
        <ng-container *ngIf="editingUser()?.id !== user.id">
          <span role="cell">{{ user.username }}</span>
          <span role="cell">{{ user.email || '‚Äî' }}</span>
          <span role="cell">
            <span class="badge" [class.badge-admin]="user.is_staff">
              {{ user.is_staff ? 'Sim' : 'N√£o' }}
            </span>
          </span>
          <span role="cell">{{ user.date_joined | date: 'dd/MM/yyyy HH:mm' }}</span>
          <span role="cell" class="table-actions">
            <button type="button" class="btn-icon btn-primary" (click)="startEditUser(user)" title="Editar usu√°rio">
              ‚úèÔ∏è
            </button>
            <button
              type="button"
              class="btn-icon btn-danger"
              (click)="deleteUser(user)"
              [disabled]="!canDeleteUser(user) || actionLoading()"
              [title]="canDeleteUser(user) ? 'Excluir usu√°rio' : 'N√£o √© poss√≠vel excluir pr√≥prio usu√°rio'"
            >
              üóëÔ∏è
            </button>
          </span>
        </ng-container>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingState>
    <div class="admin-users__status">
      <div class="spinner"></div>
      <p>Carregando usu√°rios...</p>
    </div>
  </ng-template>

  <ng-template #emptyState>
    <div class="admin-users__status">
      <p>Nenhum usu√°rio cadastrado encontrado.</p>
    </div>
  </ng-template>
</section>
