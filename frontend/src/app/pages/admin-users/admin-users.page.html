<section class="admin" aria-labelledby="users-title">
  <div class="admin-card">
    <header class="admin-header">
      <h2 id="users-title">Gestão de usuários</h2>
      <button type="button" class="ghost" (click)="load()" [disabled]="loading()">Recarregar</button>
    </header>

    <!-- Criar novo usuário -->
    <form [formGroup]="createForm" (ngSubmit)="submitCreate()" class="block" novalidate>
      <h3>Novo usuário</h3>
      <div class="grid">
        <label>
          Usuário
          <input type="text" formControlName="username" required />
        </label>

        <label>
          E-mail
          <input type="email" formControlName="email" />
        </label>

        <label>
          Senha
          <input type="password" formControlName="password" placeholder="mín. 8 caracteres" required />
        </label>

        <label>
          Confirmar
          <input type="password" formControlName="password_confirm" required />
        </label>

        <label class="checkbox">
          <input type="checkbox" formControlName="is_staff" />
          <span>Admin</span>
        </label>
      </div>

      <div class="inline-errors" *ngIf="createForm.invalid && createForm.touched">
        <p *ngIf="createForm.get('username')?.invalid">Informe um usuário.</p>
        <p *ngIf="createForm.get('password')?.hasError('minlength')">Senha deve ter pelo menos 8 caracteres.</p>
      </div>

      <div class="actions-row">
        <button type="submit" class="primary" [disabled]="createForm.invalid || loading()">Criar</button>
        <button type="button" class="ghost" (click)="createForm.reset({ is_staff: false })">Limpar</button>
      </div>
    </form>

    <!-- Lista de usuários -->
    <div class="block">
      <h3>Usuários</h3>

      <ul class="table" role="table" aria-label="Tabela de usuários">
        <li class="row header" role="row">
          <span role="columnheader">Usuário</span>
          <span role="columnheader">E-mail</span>
          <span role="columnheader" class="center">Admin</span>
          <span role="columnheader" class="right">Ações</span>
        </li>

        <li class="row" role="row" *ngFor="let u of users(); trackBy: trackById">
          <span role="cell">{{ u.username }}</span>
          <span role="cell">{{ u.email || '—' }}</span>

          <span role="cell" class="center">
            <button type="button" class="chip" [class.on]="u.is_staff" (click)="toggleAdmin(u)">
              {{ u.is_staff ? 'Sim' : 'Não' }}
            </button>
          </span>

          <span role="cell" class="right actions">
            <button
              type="button"
              (click)="openReset(u.id)"
              [disabled]="isCurrentUser(u.id)"
              [title]="isCurrentUser(u.id) ? 'Não é possível redefinir sua própria senha por este painel' : 'Redefinir senha do usuário'"
            >
              Reset senha
            </button>
            <button
              type="button"
              class="danger"
              (click)="remove(u)"
              [disabled]="isCurrentUser(u.id)"
              [title]="isCurrentUser(u.id) ? 'Não é possível excluir sua própria conta' : 'Excluir usuário'"
            >
              Excluir
            </button>
          </span>

          <!-- Caixa de reset inline -->
          <div class="reset-box" *ngIf="resetRow() === u.id">
            <form [formGroup]="resetForm" (ngSubmit)="submitReset(u.id)" novalidate>
              <div class="grid-compact">
                <label>
                  Nova senha
                  <input type="password" formControlName="new_password" placeholder="mín. 8 caracteres" required />
                </label>
                <label>
                  Confirmar
                  <input type="password" formControlName="new_password_confirm" required />
                </label>
              </div>

              <div class="inline-errors" *ngIf="resetForm.invalid && resetForm.touched">
                <p *ngIf="resetForm.get('new_password')?.hasError('minlength')">Senha deve ter pelo menos 8 caracteres.</p>
              </div>

              <div class="actions-row">
                <button type="submit" class="primary" [disabled]="resetForm.invalid || loading()">Salvar</button>
                <button type="button" class="ghost" (click)="closeReset()">Cancelar</button>
              </div>
            </form>
          </div>
        </li>

        <li class="row empty" *ngIf="!users().length && !loading()">Nenhum usuário encontrado.</li>
      </ul>
    </div>
  </div>
</section>
